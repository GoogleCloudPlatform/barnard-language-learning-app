steps:
- id: 'clone-github-repo'
  name: 'gcr.io/cloud-builders/git' 
  args: [ 'clone', 'https://github.com/GoogleCloudPlatform/barnard-language-learning-app.git']

- id: 'change-code'
  name: ubuntu
  entrypoint: bash
  args:
  - '-c'
  - |
    sed -i "s/barnard-project/${PROJECT_ID}/g" .firebaserc
    sed -i "s/barnard-project/${PROJECT_ID}/g" ./src/utils/ApiUtils.js
  
  - id: 'configure_firebase_object'
    name: node:10.16.3
    entrypoint: "node"
    args: ["./create_config.js",
           "${_API_KEY}",
           "${PROJECT_ID}",
           "${_PROJECT_NUMBER}",
           "${_APP_ID}"
         ]
    dir: "./deploy"

- name: 'gcr.io/$PROJECT_ID/firebase'
  args: [ 'use', '${PROJECT_ID}', '--token', '${_FIREBASE_TOKEN}']

- name: 'gcr.io/cloud-builders/npm'
  dir: 'functions'
  args: ['install']
  
- name: 'gcr.io/$PROJECT_ID/firebase'
  dir: 'functions'
  args: [ 'deploy', '--only', 'functions', '--token', '${_FIREBASE_TOKEN}'] 

- name: 'gcr.io/cloud-builders/npm'
  dir: 'functions'
  args: ['install']

- name: 'gcr.io/$PROJECT_ID/firebase'
  dir: 'functions'
  args: [ 'deploy', '--only', 'functions', '--token', '${_FIREBASE_TOKEN}']

- name: 'gcr.io/cloud-builders/npm'
  args: ['install']

- name: 'gcr.io/cloud-builders/npm'
  args: ['run', 'build']

- id: 'deploy-firebase'
  name: 'gcr.io/$PROJECT_ID/firebase'
  args: ['deploy', '--token', '${_FIREBASE_TOKEN}']

# gcloud builds submit . --config cloudbuild.yaml --substitutions _FIREBASE_TOKEN=ya29.ImSyB7dJ2C_GD66lawH50F9aVmQWQTXrpDTuHo8j5xqAzUK3y95TIQZ24ALSuTeV-bht1-m15S6pdNs-2sK_dNuaJw9U3Bc_bcg0R_oBD94e8X1cYXAaDjJ2yrkAJvMIb6-HXVW5
